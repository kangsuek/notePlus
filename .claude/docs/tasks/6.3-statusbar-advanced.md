# 6.3 StatusBar 고급 기능 세부 계획

## 개요
StatusBar에 파일 인코딩 자동 감지/표시 및 실시간 업데이트 최적화 기능을 구현합니다.

**우선순위**: P2 (Medium)
**예상 소요**: 1.5일
**현재 상태**: 파일 인코딩 감지 기능 일부 구현 완료 ✅

## 이미 완료된 작업 (2025-10-13)

### 1. 파일 인코딩 감지 시스템 ✅
- **파일**: `src/main/utils/encodingDetector.ts` (완료)
- **테스트**: `src/main/utils/encodingDetector.test.ts` (12개 테스트 통과)
- **기능**:
  - BOM 감지 (UTF-8, UTF-16LE, UTF-16BE)
  - jschardet를 통한 내용 기반 인코딩 감지
  - 지원 인코딩: UTF-8, UTF-16LE, UTF-16BE, EUC-KR, CP949, Windows-1252, ISO-8859-1
  - 신뢰도 기반 폴백 (신뢰도 < 0.5 → UTF-8)
  - 성능 최적화 (첫 64KB만 분석)

### 2. 파일 읽기 통합 ✅
- **파일**: `src/main/index.ts` (수정 완료)
- **변경사항**:
  - `file:read` IPC 핸들러에 인코딩 감지 추가
  - Buffer로 파일 읽기 → 인코딩 감지 → 디코딩
  - iconv-lite로 다양한 인코딩 디코딩 지원
  - 응답에 `encoding` 필드 포함

### 3. 렌더러 통합 ✅
- **파일**:
  - `src/renderer/utils/fileOperations.ts` (수정 완료)
  - `src/renderer/components/Layout/MainLayout.tsx` (수정 완료)
- **변경사항**:
  - `ReadFileResult` 인터페이스에 `encoding` 필드 추가
  - `currentEncoding` 상태 관리
  - StatusBar에 동적 인코딩 표시

### 4. 테스트 픽스처 ✅
- **디렉토리**: `tests/fixtures/encodings/`
- **파일**:
  - `utf8.txt` - UTF-8 인코딩 테스트
  - `utf16le.txt` - UTF-16LE 인코딩 테스트
  - `utf8bom.txt` - UTF-8 BOM 테스트
  - `ascii.txt` - ASCII 테스트

## 남은 작업

### Task 1: StatusBar 인코딩 표시 개선 [P1]
**예상 소요**: 0.5일

**현재 상태**: 인코딩이 표시되지만 사용자 인터랙션 없음

**구현 사항**:
1. **인코딩 레이블 클릭 가능하게 만들기**
   - 클릭 시 드롭다운 메뉴 표시
   - 사용 가능한 인코딩 목록 표시
   - 현재 인코딩 하이라이트

2. **수동 인코딩 변경 기능**
   - 사용자가 인코딩 선택 시 파일 재로드
   - 선택한 인코딩으로 파일 디코딩
   - 인코딩 변경 실패 시 에러 처리

3. **인코딩 변경 IPC 추가**
   ```typescript
   // preload.ts
   'file:reloadWithEncoding' // 새 IPC 채널

   // index.ts (main)
   ipcMain.handle('file:reloadWithEncoding', async (_event, filePath, encoding) => {
     // 지정된 인코딩으로 파일 재로드
   })
   ```

**테스트**:
- [ ] StatusBar 인코딩 클릭 시 드롭다운 표시
- [ ] 인코딩 선택 시 파일 재로드
- [ ] 잘못된 인코딩 선택 시 에러 처리
- [ ] 인코딩 변경 후 StatusBar 업데이트

**파일**:
- `src/renderer/components/StatusBar/StatusBar.tsx` (수정)
- `src/renderer/components/StatusBar/StatusBar.css` (수정)
- `src/main/preload.ts` (IPC 채널 추가)
- `src/main/index.ts` (IPC 핸들러 추가)

### Task 2: 실시간 업데이트 최적화 [P2]
**예상 소요**: 0.5일

**현재 상태**: StatusBar가 모든 커서 이동 시 업데이트됨

**구현 사항**:
1. **디바운싱 적용**
   - 커서 위치 업데이트에 디바운싱 적용 (100ms)
   - throttle 유틸리티 재사용
   ```typescript
   // MainLayout.tsx
   const debouncedCursorUpdate = useMemo(
     () => debounce((position: CursorPosition) => {
       setCursorPosition(position);
     }, 100),
     []
   );
   ```

2. **메모이제이션**
   - StatusBar 컴포넌트에 React.memo 적용
   - Props 비교 함수 최적화
   ```typescript
   export default React.memo(StatusBar, (prev, next) => {
     return (
       prev.cursorPosition?.line === next.cursorPosition?.line &&
       prev.cursorPosition?.column === next.cursorPosition?.column &&
       prev.encoding === next.encoding &&
       prev.isDirty === next.isDirty &&
       prev.showStatus === next.showStatus
     );
   });
   ```

3. **성능 측정**
   - StatusBar 렌더링 횟수 모니터링
   - 불필요한 렌더링 제거

**테스트**:
- [ ] 커서 이동 시 디바운싱 적용 확인
- [ ] StatusBar 렌더링 횟수 감소 확인
- [ ] 성능 벤치마크 (렌더링 시간)

**파일**:
- `src/renderer/components/StatusBar/StatusBar.tsx` (수정)
- `src/renderer/components/Layout/MainLayout.tsx` (수정)
- `src/__tests__/components/StatusBar/StatusBar.test.tsx` (테스트 추가)

### Task 3: 인코딩 감지 신뢰도 표시 [P3] (선택)
**예상 소요**: 0.5일

**현재 상태**: 인코딩 감지 결과만 표시

**구현 사항**:
1. **신뢰도 아이콘 추가**
   - 높은 신뢰도 (>0.8): 녹색 체크마크
   - 중간 신뢰도 (0.5-0.8): 노란색 경고
   - 낮은 신뢰도 (<0.5): UTF-8 폴백 표시

2. **툴팁 추가**
   - 마우스 오버 시 상세 정보 표시
   - "자동 감지됨 (신뢰도: 85%)"
   - "사용자 선택"
   - "기본값 (UTF-8)"

**테스트**:
- [ ] 신뢰도에 따른 아이콘 표시
- [ ] 툴팁 내용 확인

**파일**:
- `src/renderer/components/StatusBar/StatusBar.tsx` (수정)
- `src/renderer/components/StatusBar/StatusBar.css` (스타일 추가)
- `src/main/utils/encodingDetector.ts` (신뢰도 반환)

## 인터페이스 변경

### 1. EncodingResult 인터페이스 (새로 추가)
```typescript
// src/shared/types.ts
export interface EncodingResult {
  encoding: string;        // 감지된 인코딩
  confidence: number;      // 신뢰도 (0-1)
  source: 'auto' | 'user' | 'default';  // 소스
}
```

### 2. StatusBar Props 확장
```typescript
// src/renderer/types.ts
export interface StatusBarProps {
  cursorPosition?: CursorPosition;
  encoding?: string;
  encodingConfidence?: number;  // 새로 추가
  encodingSource?: 'auto' | 'user' | 'default';  // 새로 추가
  isDirty?: boolean;
  showStatus?: boolean;
  onEncodingChange?: (encoding: string) => void;  // 새로 추가
}
```

### 3. IPC 채널 추가
```typescript
// preload.ts validChannels
'file:reloadWithEncoding',  // 인코딩 변경 후 재로드
```

## 테스트 계획

### 단위 테스트
1. **StatusBar 컴포넌트** (8개 기존 + 5개 추가 = 13개)
   - [x] 기본 렌더링 (기존)
   - [x] 커서 위치 표시 (기존)
   - [x] 인코딩 표시 (기존)
   - [x] isDirty 상태 (기존)
   - [ ] 인코딩 드롭다운 표시
   - [ ] 인코딩 변경 콜백
   - [ ] 신뢰도 아이콘 표시
   - [ ] 툴팁 표시
   - [ ] 메모이제이션 동작

2. **인코딩 감지** (12개 기존)
   - [x] BOM 감지 (기존)
   - [x] 내용 기반 감지 (기존)
   - [x] 폴백 동작 (기존)

3. **MainLayout 통합** (16개 기존 + 2개 추가 = 18개)
   - [x] 파일 열기 시 인코딩 표시 (기존)
   - [ ] 인코딩 변경 시 재로드
   - [ ] 커서 업데이트 디바운싱

### 통합 테스트
1. **파일 인코딩 워크플로우**
   - [ ] 다양한 인코딩 파일 열기
   - [ ] 인코딩 자동 감지 확인
   - [ ] 수동 인코딩 변경
   - [ ] 잘못된 인코딩 처리

### 성능 테스트
1. **StatusBar 렌더링 성능**
   - [ ] 커서 이동 시 렌더링 횟수 < 10/초
   - [ ] 디바운싱 동작 확인
   - [ ] 메모이제이션 효과 확인

## 성공 기준

1. **기능적 요구사항**
   - [x] 파일 인코딩 자동 감지 (UTF-8, UTF-16, EUC-KR 등)
   - [x] StatusBar에 인코딩 표시
   - [ ] 인코딩 수동 변경 기능
   - [ ] 실시간 업데이트 최적화 (디바운싱)

2. **성능 요구사항**
   - [ ] 인코딩 감지 시간 < 100ms (대부분의 파일)
   - [ ] StatusBar 렌더링 < 10회/초
   - [ ] 메모리 누수 없음

3. **테스트 요구사항**
   - [x] 인코딩 감지 테스트 12개 통과
   - [ ] StatusBar 테스트 13개 통과
   - [ ] 통합 테스트 모두 통과
   - [ ] 전체 커버리지 75%+ 유지

4. **사용자 경험**
   - [x] 인코딩 자동 감지 (사용자 개입 불필요)
   - [ ] 잘못된 인코딩 시 쉽게 변경 가능
   - [ ] 빠른 응답 시간 (디바운싱으로 부드러운 UX)

## 위험 요소 및 대응

### 1. 인코딩 감지 정확도
**위험**: jschardet가 일부 인코딩을 오감지할 수 있음
**대응**:
- 수동 인코딩 변경 기능 제공
- 신뢰도 표시로 사용자에게 정보 제공
- 폴백으로 UTF-8 사용 (가장 보편적)

### 2. 성능 이슈
**위험**: 대용량 파일에서 인코딩 감지 시간이 오래 걸릴 수 있음
**대응**:
- 첫 64KB만 분석 (이미 구현됨)
- 백그라운드 스레드 사용 (추후 고려)

### 3. 메모리 누수
**위험**: StatusBar가 너무 자주 렌더링되어 메모리 누수 가능
**대응**:
- React.memo로 불필요한 렌더링 방지
- 디바운싱으로 업데이트 빈도 제한
- useEffect cleanup 함수로 타이머 정리

## 구현 순서

1. **Day 1 (오전)**: Task 1 - 인코딩 드롭다운 UI
   - StatusBar 컴포넌트 수정
   - 드롭다운 메뉴 구현
   - CSS 스타일링

2. **Day 1 (오후)**: Task 1 - 수동 인코딩 변경
   - IPC 채널 추가
   - 파일 재로드 로직
   - 테스트 작성 및 통과

3. **Day 2 (오전)**: Task 2 - 실시간 업데이트 최적화
   - 디바운싱 적용
   - React.memo 추가
   - 성능 벤치마크

4. **Day 2 (오후)**: Task 3 - 신뢰도 표시 (선택)
   - 신뢰도 아이콘 추가
   - 툴팁 구현
   - 최종 테스트 및 문서 업데이트

## 참고 자료

- jschardet: https://github.com/aadsm/jschardet
- iconv-lite: https://github.com/ashtuchkin/iconv-lite
- React.memo: https://react.dev/reference/react/memo
- 디바운싱/스로틀링: 프로젝트 내 `src/renderer/utils/throttle.ts`

## 다음 단계 (Week 7)

6.3 완료 후:
- 7.1 다양한 파일 인코딩 지원 (추가 인코딩, BOM 처리 개선)
- 7.2 파일 감시 및 자동 새로고침
- 7.3 추가 파일 포맷 지원 (PDF, HTML)
